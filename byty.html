<!DOCTYPE html>
<html lang="sk">
<head>
<link rel="manifest" href="manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#d32f2f">
<title>VELITEƒΩ: Bytov√Ω dom</title>
<style>
    /* CSS CORE */
    :root { --primary: #d32f2f; --dark: #222; --light: #f4f4f4; --blue: #007bff; --green: #28a745; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: var(--light); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; }
    
    /* NAVIG√ÅCIA */
    .tabs { display: flex; background: var(--dark); color: white; height: 60px; flex-shrink: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .tab { flex: 1; text-align: center; line-height: 60px; cursor: pointer; border-bottom: 5px solid transparent; font-weight: bold; font-size: 16px; text-transform: uppercase; }
    .tab.active { border-bottom-color: var(--primary); background: #333; }
    
    .sys-status { position: absolute; top: 20px; right: 15px; width: 12px; height: 12px; border-radius: 50%; background: gray; z-index: 200; border: 2px solid white; }
    .sys-running { background: #00ff00; box-shadow: 0 0 8px #00ff00; animation: pulseDot 1s infinite; }
    @keyframes pulseDot { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    .tab-content { display: none; flex: 1; overflow-y: auto; position: relative; -webkit-overflow-scrolling: touch; padding-bottom: 80px; }
    .tab-content.active { display: block; }

    /* SETUP */
    .setup-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
    .setup-group { width: 100%; max-width: 400px; margin-bottom: 20px; text-align: left; }
    .setup-group label { font-weight: bold; display: block; margin-bottom: 5px; }
    .setup-group input { width: 100%; padding: 12px; font-size: 18px; border: 1px solid #ccc; border-radius: 5px; text-align: center; }
    .btn-big { width: 100%; padding: 18px; font-size: 20px; font-weight: bold; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
    .btn-green { background: var(--green); }
    .chk-line { display: flex; align-items: center; background: #eee; padding: 15px; margin-bottom: 5px; border-radius: 8px; font-size: 18px; }
    .chk-line input { width: 30px; height: 30px; margin-right: 15px; }

    /* MAPA */
    .table-wrapper { width: 100%; height: 100%; overflow: auto; padding: 5px; box-sizing: border-box; display:flex; flex-direction: column; align-items: center; }
    #mapScaleWrapper { transform-origin: top center; width: 100%; max-width: 700px; transition: transform 0.2s; padding-bottom: 60px; }
    
    .base-station { background: #e3f2fd; border: 3px dashed #007bff; padding: 15px; margin-bottom: 20px; text-align: center; border-radius: 8px; cursor: pointer; }
    .base-title { font-size: 16px; font-weight: bold; color: #0056b3; text-transform: uppercase; }
    .badge-zone { min-height: 40px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; align-items: center; }

    /* TABLE LAYOUT */
    table.grid-table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; margin-bottom: 20px; }
    .grid-table th { background: #333; color: white; padding: 10px 2px; font-size: 11px; position: sticky; top: 0; z-index: 10; }
    .grid-table td { border: 1px solid #999; padding: 4px; text-align: center; vertical-align: middle; height: 50px; }
    
    .floor-header { background: #ddd; font-weight: bold; text-align: left; padding-left: 10px !important; font-size: 15px; border-top: 2px solid #444; color: black; }
    .room-id { font-weight: bold; color: var(--blue); text-decoration: underline; cursor: pointer; font-size: 16px; background: #fff; }
    .room-id.active { background: #ffeb3b !important; border: 3px solid black; }

    input.cell-inp { width: 100%; text-align: center; border: 1px solid #aaa; padding: 10px 0; font-size: 18px; font-weight: bold; border-radius: 4px; background: #fff; color: black; }
    input.cell-chk { width: 25px; height: 25px; border: 1px solid #666; }

    /* ODZNAKY & KARTY */
    .badge { display: inline-block; padding: 6px 10px; border-radius: 6px; font-size: 13px; font-weight: bold; color: white; margin: 3px; cursor: pointer; border: 1px solid rgba(0,0,0,0.3); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .badge.selected { border: 3px solid black; transform: scale(1.15); z-index: 100; box-shadow: 0 0 10px black; }
    .badge.badge-alarm { background-color: red !important; border-color: yellow !important; animation: pulse-red 1s infinite !important; box-shadow: 0 0 15px red; z-index: 200; }

    .group-card { background: white; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 12px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; overflow: hidden; transition: all 0.3s; }
    .group-card.selected { border: 4px solid var(--blue); background: #f0f8ff; }
    .group-card.card-alarm { border: 4px solid red !important; background: #ffebee !important; animation: pulse-red 1s infinite !important; box-shadow: 0 0 15px rgba(255,0,0,0.5) !important; z-index: 100; }

    @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.02); background-color: #ffcdd2; border-color: red; } 100% { transform: scale(1); } }

    .card-color-strip { position: absolute; top:0; left:0; bottom:0; width: 12px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-left: 20px; }
    .card-timer { font-family: monospace; font-size: 24px; font-weight: bold; background: #eee; padding: 5px 10px; border-radius: 6px; min-width: 80px; text-align: center; }
    .card-timer.running { background: #c8e6c9; color: #006400; border: 2px solid green; }
    .card-controls { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; align-items: center; padding-left: 20px; }
    .btn-ctrl { padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; font-size: 14px; flex: 1; }
    .mem-input { width: 70px; padding: 8px; text-align: center; font-weight: bold; font-size: 18px; border: 2px solid #aaa; border-radius: 6px; z-index: 50; position: relative; }

    /* FOOTER */
    .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: white; display: flex; justify-content: space-around; padding: 12px 0; border-top: 4px solid var(--primary); font-size: 12px; z-index: 2000; box-shadow: 0 -4px 10px rgba(0,0,0,0.3); }
    .f-val { font-size: 18px; font-weight: bold; display: block; margin-top: 2px; }

    /* MODAL */
    .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 6000; display: none; align-items: center; justify-content: center; }
    .modal-box { background: white; width: 90%; max-width: 450px; padding: 25px; border-radius: 10px; text-align: center; border: 5px solid #333; }
    .modal-btn { width: 100%; padding: 15px; margin-top: 10px; border: none; font-weight: bold; color: white; border-radius: 8px; cursor: pointer; font-size: 18px; }
    .btn-overview { position: fixed; bottom: 90px; right: 20px; z-index: 4000; background: rgba(0,0,0,0.85); color: white; border: 2px solid white; padding: 12px 18px; border-radius: 30px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.4); backdrop-filter: blur(5px); }

    /* TLAƒå */
    @media print {
        .setup-screen, .tabs, .footer, .btn-ctrl, .base-station, button, .modal-wrap, .btn-overview, .sys-status { display: none !important; }
        body { height: auto; overflow: visible; background: white; padding: 0; margin: 0; }
        .tab-content { display: none !important; } 
        #final-report { display: block !important; font-family: sans-serif; padding: 20px; }
        .rep-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px; }
        .rep-table th, .rep-table td { border: 1px solid black; padding: 8px; text-align: center; }
    }
    #final-report { display: none; }
</style>
</head>
<body>

<div id="setupScreen" class="setup-screen">
    <h1 style="color:var(--primary); font-size:2.5rem;">BYTOV√ù DOM</h1>
    <div class="setup-group">
        <label>Poƒçet poschod√≠:</label><input type="number" id="inpFloors" value="8">
        <label style="margin-top:15px">Bytov na poschod√≠:</label><input type="number" id="inpApts" value="3">
        <div style="margin-top:20px">
            <div class="chk-line"><input type="checkbox" id="chkSut"><label>Suter√©n</label></div>
            <div class="chk-line"><input type="checkbox" id="chkGar"><label>Gar√°≈æ</label></div>
        </div>
    </div>
    <div class="setup-group">
        <div class="chk-line" style="background:#fff3cd; border:1px solid orange;">
            <input type="checkbox" id="chkTestMode"><label>‚ö° R√ùCHLY TEST (15s)</label>
        </div>
    </div>
    <button class="btn-big btn-green" onclick="appInit()">NOV√ù Z√ÅSAH (≈†TART)</button>
    <button class="btn-big" style="background:#555; margin-top:20px; font-size:14px;" onclick="forceReset()">VYMAZA≈§ ULO≈ΩEN√â D√ÅTA</button>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('map')">MAPA</div>
    <div class="tab" onclick="switchTab('forces')">SILY (ADP)</div>
    <div class="tab" onclick="switchTab('log')">DENN√çK</div>
    <div id="sysIndicator" class="sys-status"></div>
</div>

<div id="viewMap" class="tab-content active">
    <button class="btn-overview" onclick="toggleOverview()">üëÅÔ∏è CEL√ù POHƒΩAD</button>
    <div id="mapRenderArea" class="table-wrapper">
        <div id="mapScaleWrapper">
            <div class="base-station">
                <div class="base-title">N√ÅSTUPN√ù PRIESTOR / Z√ÅKLAD≈áA</div>
                <div id="zone_BASE" class="badge-zone" onclick="logicHandleRoomClick('BASE')"></div>
            </div>
            <div id="gridContainer"></div>
        </div>
    </div>
</div>

<div id="viewForces" class="tab-content">
    <div style="padding:10px; padding-bottom: 120px;">
        <button class="btn-big" style="background:#333; margin-bottom:15px;" onclick="addForce()">+ PRIDA≈§ SKUPINU</button>
        <div id="forcesList"></div>
    </div>
</div>

<div id="viewLog" class="tab-content" style="padding:10px;">
    <button class="btn-big" style="background:var(--primary); margin-bottom:20px; border:2px solid black;" onclick="finishIncident()">üèÅ UKONƒåI≈§ A TLAƒåI≈§</button>
    <button class="btn-big" style="background:#555; margin-bottom:20px;" onclick="forceReset()">üóëÔ∏è VYMAZA≈§ D√ÅTA</button>
    <div id="logContent" style="font-family:monospace; font-size:12px;"></div>
</div>

<div class="footer">
    <div>PREHƒΩ.<br><span id="statSearch" class="f-val">0</span></div>
    <div>OSOBY<br><span id="statPers" class="f-val">0</span></div>
    <div style="color:#ff5252">ZRAN.<br><span id="statInj" class="f-val">0</span></div>
    <div style="color:#aaa">EXIT.<br><span id="statDead" class="f-val">0</span></div>
    <div style="color:#69f0ae">EVAK.<br><span id="statEvac" class="f-val">0</span></div>
    <div class="ver" style="position:absolute;right:2px;bottom:2px;font-size:9px;color:#555">v5.0</div>
</div>

<div id="modalGroup" class="modal-wrap">
    <div class="modal-box">
        <h2 id="mTitle">...</h2>
        <p id="mInfo">...<p>
        <div id="mAlarm" style="display:none; background:red; color:white; padding:10px; margin-bottom:10px; font-weight:bold;">üö® POPLACH!</div>
        <button id="mBtnCheck" class="btn-big" style="background:orange; color:black; display:none;" onclick="confirmCheck()">POTVRDI≈§ KONTROLU</button>
        <button class="btn-big" style="background:#007bff; margin-top:5px;" onclick="moveGroupFromModal()">PRESUN√ö≈§</button>
        <button class="btn-big" style="background:orange; color:black" onclick="resetAir()">NOV√ù VZDUCH</button>
        <button class="btn-big" style="background:#d32f2f; margin-top:5px;" onclick="removeForce()">UKONƒåI≈§ ƒåINNOS≈§</button>
        <button class="btn-big" style="background:#777; margin-top:15px;" onclick="document.getElementById('modalGroup').style.display='none'">ZAVRIE≈§</button>
    </div>
</div>

<div id="final-report">
    <h1>Z√ÅVEREƒåN√Å SPR√ÅVA O Z√ÅSAHU</h1>
    <p><strong>Typ:</strong> Bytov√Ω dom | <strong>D√°tum:</strong> <span id="repDate"></span></p>
    
    <h3>1. ≈†tatistika</h3>
    <table class="rep-table" style="width:100%">
        <tr><th>Prehƒæadan√©</th><th>Osoby</th><th>Zranen√≠</th><th>Exitus</th><th>Evakuovan√≠</th></tr>
        <tr><td id="repSearch">0</td><td id="repPers">0</td><td id="repInj">0</td><td id="repDead">0</td><td id="repEvac">0</td></tr>
    </table>

    <h3>2. Detail Priestorov</h3>
    <table class="rep-table" style="width:100%">
        <thead><tr><th>Priestor</th><th>Osoby</th><th>Zranen√≠</th><th>Exitus</th><th>Evakuovan√≠</th><th>Stav</th></tr></thead>
        <tbody id="repRoomsTable"></tbody>
    </table>

    <h3>3. Nasaden√© sily</h3>
    <p><strong>Celkov√Ω poƒçet nasaden√Ωch hasiƒçov:</strong> <span id="repTotalMem" style="font-weight:bold">0</span></p>
    <table class="rep-table" style="width:100%">
        <thead><tr><th>Skupina</th><th>ƒålenov</th><th>Poloha</th><th>Stav</th></tr></thead>
        <tbody id="repGroupTable"></tbody>
    </table>

    <h3>4. Denn√≠k</h3>
    <div id="repLog" style="font-family:monospace; font-size:11px; white-space: pre-wrap;"></div>
</div>

<script>
    const COLORS = [{bg:'#007bff',txt:'white'},{bg:'#ffd700',txt:'black'},{bg:'#28a745',txt:'white'},{bg:'#dc3545',txt:'white'},{bg:'#17a2b8',txt:'black'},{bg:'#6f42c1',txt:'white'},{bg:'#fd7e14',txt:'black'},{bg:'#e83e8c',txt:'white'},{bg:'#8B4513',txt:'white'},{bg:'#000000',txt:'white'}];
    
    // UNIK√ÅTNY KƒΩ√öƒå PRE BYTY
    const STORAGE_KEY = 'DATA_TREZOR_BYTY_V5';

    let APP = { 
        floors: 8, apts: 3, rooms: {}, groups:[], 
        selectedGroupId:null, 
        intervals:[900,1200,1500], // 15, 20, 25 min
        logs:[], audioCtx:null, overviewMode:false,
        lastId: 0, isRunning: false
    };

    function saveData() { if(APP.isRunning) localStorage.setItem(STORAGE_KEY, JSON.stringify(APP)); }
    function loadData() {
        const data = localStorage.getItem(STORAGE_KEY);
        if(data) { try { APP = { ...APP, ...JSON.parse(data) }; APP.audioCtx = null; return true; } catch(e){ return false; } }
        return false;
    }
    function forceReset() { if(confirm("Naozaj vymaza≈• v≈°etko?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }

    function initAudio() { try { if(!APP.audioCtx) APP.audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } catch(e){} }
    function playAlarmBeep(lvl){ 
        if(!APP.audioCtx)return; if(APP.audioCtx.state==='suspended')APP.audioCtx.resume(); 
        const o=APP.audioCtx.createOscillator(); const g=APP.audioCtx.createGain(); 
        o.frequency.value=800 + (lvl*100); o.connect(g); g.connect(APP.audioCtx.destination); 
        o.start(); o.stop(APP.audioCtx.currentTime+0.5); 
    }

    window.onload = function() {
        if(loadData() && APP.isRunning) {
            document.getElementById('setupScreen').style.display='none';
            initAudio();
            renderMapStructure(); renderMapBadgesOnly(); renderGroupList();
            setInterval(coreGameLoop, 1000);
            document.getElementById('sysIndicator').classList.add('sys-running');
            dbLog("--- OBNOVENIE REL√ÅCIE ---");
        }
    };

    function appInit() {
        initAudio();
        APP.floors = parseInt(document.getElementById('inpFloors').value);
        APP.apts = parseInt(document.getElementById('inpApts').value);
        if(document.getElementById('chkTestMode').checked) APP.intervals = [15,30,45];
        
        for(let f=APP.floors; f>=1; f--) {
            for(let a=1; a<=APP.apts; a++) dbCreateRoom(`${f}.${a}`);
        }
        if(document.getElementById('chkGar').checked) dbCreateRoom('GAR');
        if(document.getElementById('chkSut').checked) dbCreateRoom('SUT');

        APP.isRunning = true;
        document.getElementById('setupScreen').style.display='none';
        renderMapStructure(); renderMapBadgesOnly(); 
        
        setInterval(coreGameLoop, 1000);
        document.getElementById('sysIndicator').classList.add('sys-running');
        dbLog("≈†tart syst√©mu: Bytov√Ω dom");
        saveData();
    }

    function dbCreateRoom(id) { APP.rooms[id] = {s:false, p:0, i:0, d:0, e:0}; }

    function renderMapStructure() {
        let h = `<table class="grid-table"><thead><tr>
            <th>BYT</th><th>JEDNOTKY</th><th>‚úî</th><th>üîë</th><th>OS</th><th>ZR</th><th>EX</th><th>EV</th>
        </tr></thead><tbody>`;
        
        const row = (id) => `<tr>
            <td class="room-id" id="cell_${id}" onclick="logicHandleRoomClick('${id}')">${id}</td>
            <td id="badge_${id}" class="badge-zone" onclick="logicHandleRoomClick('${id}')"></td>
            <td><input type="checkbox" class="cell-chk" ${APP.rooms[id].s?'checked':''} onchange="dbUpdateRoom('${id}','s',this.checked)"></td>
            <td><input type="checkbox" class="cell-chk"></td>
            <td><input type="number" class="cell-inp" value="${APP.rooms[id].p}" onclick="this.select()" onchange="dbUpdateRoom('${id}','p',this.value)"></td>
            <td><input type="number" class="cell-inp" value="${APP.rooms[id].i}" style="color:red" onclick="this.select()" onchange="dbUpdateRoom('${id}','i',this.value)"></td>
            <td><input type="number" class="cell-inp" value="${APP.rooms[id].d}" style="background:black;color:white" onclick="this.select()" onchange="dbUpdateRoom('${id}','d',this.value)"></td>
            <td><input type="number" class="cell-inp" value="${APP.rooms[id].e}" style="color:green" onclick="this.select()" onchange="dbUpdateRoom('${id}','e',this.value)"></td>
        </tr>`;

        for(let f=APP.floors; f>=1; f--) {
            h += `<tr><td colspan="8" class="floor-header" id="floor_${f}">${f}. POSCHODIE</td></tr>`;
            for(let a=1; a<=APP.apts; a++) h += row(`${f}.${a}`);
        }
        if(APP.rooms['GAR']) h += `<tr><td colspan="8" class="floor-header">GAR√Å≈ΩE</td></tr>` + row('GAR');
        if(APP.rooms['SUT']) h += `<tr><td colspan="8" class="floor-header">SUTER√âN</td></tr>` + row('SUT');
        
        document.getElementById('gridContainer').innerHTML = h + "</tbody></table>";
        updateFloorColors();
    }

    function renderMapBadgesOnly() {
        document.querySelectorAll('.badge-zone').forEach(el => el.innerHTML = "");
        APP.groups.forEach(g => {
            if(g.status === 'finished') return;
            let b = document.createElement('span');
            let isAlarm = (g.alarmLevel > g.ackLevel);
            let alarmClass = isAlarm ? 'badge-alarm' : '';
            b.className = `badge ${APP.selectedGroupId===g.id?'selected':''} ${alarmClass}`;
            b.style.backgroundColor = g.colorObj.bg; b.style.color = g.colorObj.txt;
            b.innerText = g.name;
            b.onclick = (e) => { e.stopPropagation(); logicBadgeClick(g.id); };
            let t = (g.loc==='BASE')?'zone_BASE':`badge_${g.loc}`;
            let z = document.getElementById(t); if(z) z.appendChild(b);
        });
        
        document.querySelectorAll('.room-id').forEach(e => e.classList.remove('active'));
        if(APP.selectedGroupId) {
            let g = APP.groups.find(x => x.id === APP.selectedGroupId);
            if(g && g.loc !== 'BASE') {
                let cell = document.getElementById(`cell_${g.loc}`);
                if(cell) cell.classList.add('active');
            }
        }
        updateFloorColors();
    }

    function renderGroupList() {
        const area = document.getElementById('forcesList'); area.innerHTML = "";
        APP.groups.forEach(g => {
            if(g.status === 'finished') return;
            let alarmClass = (g.alarmLevel > g.ackLevel) ? 'card-alarm' : '';
            let div = document.createElement('div');
            div.className = `group-card ${APP.selectedGroupId===g.id?'selected':''} ${alarmClass}`;
            div.onclick = () => logicSelectGroup(g.id);
            let tmClass = g.status === 'running' ? 'card-timer running' : 'card-timer';
            div.innerHTML = `<div class="card-color-strip" style="background:${g.colorObj.bg}"></div>
                <div class="card-header"><div><b>${g.name}</b> <small>(${g.loc})</small></div><div class="${tmClass}" id="tm_${g.id}">${utilFormatTime(g.elapsed)}</div></div>
                <div style="font-size:14px; margin-bottom:10px; padding-left:18px; display:flex; align-items:center;">
                    Poƒçet hasiƒçov: <input type="number" class="mem-input" value="${g.members}" onclick="event.stopPropagation(); this.select();" oninput="dbUpdateMember(${g.id}, this.value)">
                </div>
                <div class="card-controls">
                    ${(g.alarmLevel>g.ackLevel) ? `<button class="btn-ctrl btn-confirm" onclick="event.stopPropagation();logicOpenGroupModal(${g.id})">ALARM!</button>` : ''}
                    ${g.status==='idle' ? `<button class="btn-ctrl" style="background:green" onclick="event.stopPropagation();logicTimerStart(${g.id})">≈†TART</button>` : `<button class="btn-ctrl" style="background:red" onclick="event.stopPropagation();logicTimerStop(${g.id})">STOP</button>`}
                    <button class="btn-ctrl" style="background:#333" onclick="event.stopPropagation();logicOpenGroupModal(${g.id})">INFO</button>
                </div>`;
            area.appendChild(div);
        });
    }

    function addForce() {
        APP.lastId++; let id = APP.lastId;
        let displayName = `SKUPINA ${APP.groups.length + 1}`;
        APP.groups.push({id:id, name:displayName, loc:'BASE', status:'idle', elapsed:0, alarmLevel:0, ackLevel:0, members:2, colorObj:COLORS[(id-1)%COLORS.length]});
        logicSelectGroup(id); renderMapBadgesOnly(); renderGroupList(); dbLog(`Vytvoren√°: ${displayName}`); saveData();
    }
    function logicSelectGroup(id) { APP.selectedGroupId = (APP.selectedGroupId===id) ? null : id; renderGroupList(); renderMapBadgesOnly(); }
    function logicHandleRoomClick(id) {
        if(APP.selectedGroupId) {
            let g = APP.groups.find(x=>x.id===APP.selectedGroupId);
            if(g) { g.loc = id; APP.selectedGroupId=null; dbLog(`${g.name} presun -> ${id}`); renderMapBadgesOnly(); renderGroupList(); saveData(); }
        }
    }
    function coreGameLoop() {
        let redraw = false;
        APP.groups.forEach(g => {
            if(g.status === 'running') {
                g.elapsed++;
                let el = document.getElementById(`tm_${g.id}`); if(el) el.innerText = utilFormatTime(g.elapsed);
                if(g.elapsed >= APP.intervals[0] && g.alarmLevel === 0) { g.alarmLevel = 1; redraw = true; playAlarmBeep(1); }
                if(g.elapsed >= APP.intervals[1] && g.alarmLevel === 1) { g.alarmLevel = 2; redraw = true; playAlarmBeep(2); }
                if(g.elapsed >= APP.intervals[2] && g.alarmLevel === 2) { g.alarmLevel = 3; redraw = true; playAlarmBeep(3); }
            }
        });
        if(redraw) { renderGroupList(); renderMapBadgesOnly(); }
        if(Date.now() % 5000 < 100) saveData();
    }
    function dbUpdateRoom(id, f, v) { 
        if(f!=='s') v=parseInt(v)||0;
        let old = APP.rooms[id][f]; APP.rooms[id][f] = v; 
        if(f==='s' && v===true && old===false) dbLog(`${id}: PREHƒΩADAN√â`);
        if(f==='p' && v > old) dbLog(`${id}: N√°jden√° OSOBA (Spolu: ${v})`);
        
        if(f==='s') updateFloorColors();
        dbCalcTotals(); saveData();
    }
    function dbUpdateMember(id, v) { APP.groups.find(x=>x.id===id).members = parseInt(v)||0; updateFooterStats(); saveData(); }
    function updateFooterStats(){ dbCalcTotals(); }
    function updateFloorColors() {
        for(let f=1; f<=APP.floors; f++) {
            let el = document.getElementById(`floor_${f}`);
            if(!el) continue;
            let tot=0, ok=0;
            for(let a=1; a<=APP.apts; a++) { if(APP.rooms[`${f}.${a}`]) { tot++; if(APP.rooms[`${f}.${a}`].s) ok++; } }
            if(tot>0 && ok===tot) el.style.background = '#c8e6c9'; 
            else if(ok>0) el.style.background = '#fff9c4'; 
            else el.style.background = '#ddd';
        }
    }
    function dbCalcTotals() {
        let s=0,p=0,i=0,d=0,e=0;
        for(let k in APP.rooms) { let r = APP.rooms[k]; if(r.s) s++; p+=r.p; i+=r.i; d+=r.d; e+=r.e; }
        document.getElementById('statSearch').innerText=s; document.getElementById('statPers').innerText=p;
        document.getElementById('statInj').innerText=i; document.getElementById('statDead').innerText=d; document.getElementById('statEvac').innerText=e;
        return {s,p,i,d,e};
    }
    let _modId = null;
    function logicBadgeClick(id) { let g=APP.groups.find(x=>x.id===id); if(g.alarmLevel>g.ackLevel) logicOpenGroupModal(id); else logicSelectGroup(id); }
    function logicOpenGroupModal(id) { _modId=id; let g=APP.groups.find(x=>x.id===id); document.getElementById('mTitle').innerText=g.name; document.getElementById('mInfo').innerText=`Poloha: ${g.loc} | ƒåas: ${utilFormatTime(g.elapsed)}`; let alert=document.getElementById('mAlarm'); let btn=document.getElementById('mBtnCheck'); if(g.alarmLevel>g.ackLevel){alert.style.display='block';btn.style.display='block';}else{alert.style.display='none';btn.style.display='none';} document.getElementById('modalGroup').style.display='flex'; }
    function confirmCheck() { let g=APP.groups.find(x=>x.id===_modId); g.ackLevel=g.alarmLevel; uiCloseModal(); renderGroupList(); renderMapBadgesOnly(); saveData(); }
    function moveGroupFromModal() { APP.selectedGroupId = _modId; uiCloseModal(); switchTab('map'); }
    function resetAir() { if(confirm("Vymeni≈• fƒæa≈°e?")) { let g=APP.groups.find(x=>x.id===_modId); g.elapsed=0; g.alarmLevel=0; g.ackLevel=0; uiCloseModal(); renderGroupList(); renderMapBadgesOnly(); saveData(); } }
    function removeForce() { if(confirm("Ukonƒçi≈•?")) { APP.groups.find(x=>x.id===_modId).status='finished'; uiCloseModal(); renderGroupList(); renderMapBadgesOnly(); saveData(); } }
    function logicTimerStart(id){ APP.groups.find(x=>x.id===id).status='running'; renderGroupList(); saveData(); }
    function logicTimerStop(id){ APP.groups.find(x=>x.id===id).status='idle'; renderGroupList(); saveData(); }
    function switchTab(t) { document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active')); if(t==='map'){document.querySelectorAll('.tab')[0].classList.add('active');document.getElementById('viewMap').classList.add('active');} if(t==='forces'){document.querySelectorAll('.tab')[1].classList.add('active');document.getElementById('viewForces').classList.add('active');} if(t==='log'){document.querySelectorAll('.tab')[2].classList.add('active');document.getElementById('viewLog').classList.add('active');} }
    function uiCloseModal() { document.getElementById('modalGroup').style.display='none'; }
    function toggleOverview() { APP.overviewMode=!APP.overviewMode; let w=document.getElementById('mapScaleWrapper'); if(APP.overviewMode){ let h=window.innerHeight-150; let s=Math.min(h/w.scrollHeight,1); w.style.width="100%"; w.style.transform=`scale(${s})`; w.style.width=`${100/s}%`; } else { w.style.transform="scale(1)"; w.style.width="100%"; } }
    function dbLog(m) { let t=new Date().toLocaleTimeString(); APP.logs.push({t,m}); document.getElementById('logContent').innerHTML=`<div><b>${t}</b> ${m}</div>`+document.getElementById('logContent').innerHTML; saveData(); }
    function utilFormatTime(s) { return new Date(s*1000).toISOString().substr(14,5); }
    function finishIncident() { 
        if(!confirm("Ukonƒçi≈• z√°sah?"))return; 
        document.getElementById('repDate').innerText=new Date().toLocaleString(); 
        let s=dbCalcTotals(); document.getElementById('repSearch').innerText=s.s; document.getElementById('repPers').innerText=s.p; document.getElementById('repInj').innerText=s.i; document.getElementById('repDead').innerText=s.d; document.getElementById('repEvac').innerText=s.e;
        let t=""; let totalMem = 0;
        APP.groups.forEach(g=>{ totalMem += parseInt(g.members)||0; t+=`<tr><td>${g.name}</td><td>${g.members}</td><td>${g.loc}</td><td>${g.status} (${utilFormatTime(g.elapsed)})</td></tr>`; }); 
        document.getElementById('repGroupTable').innerHTML=t;
        document.getElementById('repTotalMem').innerText = totalMem;
        let rt = "";
        for(let k in APP.rooms) { let r = APP.rooms[k]; if(r.s || r.p>0 || r.i>0 || r.d>0 || r.e>0) { rt += `<tr><td>${k}</td><td>${r.p}</td><td>${r.i}</td><td>${r.d}</td><td>${r.e}</td><td>${r.s?'PREHƒΩADAN√â':'-'}</td></tr>`; } }
        document.getElementById('repRoomsTable').innerHTML = rt;
        document.getElementById('repLog').innerText=APP.logs.map(l=>`[${l.t}] ${l.m}`).join('\n');
        window.print(); 
    }
    setInterval(updateFooterStats, 2000);
</script>

<script>
    if ('serviceWorker' in navigator) { 
        navigator.serviceWorker.register('./sw.js'); 
    }
</script>

</body>
</html>